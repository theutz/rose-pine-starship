name: Generate Config
on:
  push:
    paths:
      - ".github/workflows/combine.yml"

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Generate language config
        run: bash ./src/modules/languages/languages.sh
        
      - name: Commit & push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add languages.toml

      - name: Install jq
        run: sudo apt-get install -y jq
        
      - name: Build configs from JSON
        run: |
          mkdir -p example

          # Define what "languages" expands to
          lang_modules="c elixir elm golang haskell java julia nodejs nim rust scala python"

          configs=$(jq -c '.[]' ./src/configs.json)
          for cfg in $configs; do
            name=$(echo "$cfg" | jq -r '.name')
            modules=$(echo "$cfg" | jq -r '.modules[]')

            output="example/${name}.toml"
            : > "$output"

            format=""

            for mod in $modules; do
              if [ "$mod" = "languages" ]; then
                # Expand all languages
                for lang in $lang_modules; do
                  if [ -f "src/modules/${lang}.toml" ]; then
                    cat "src/modules/${lang}.toml" >> "$output"
                    echo -e "\n" >> "$output"
                  fi
                  format="$format \$$lang"
                done
              else
                if [ -f "src/modules/${mod}.toml" ]; then
                  cat "src/modules/${mod}.toml" >> "$output"
                  echo -e "\n" >> "$output"
                fi
                format="$format \$$mod"
              fi
            done

            # Add the format block at the bottom
            cat >> "$output" <<EOF
            format = """
            ${format}\n  \
            [ó±ª](fg:iris)
            """
              EOF
            echo "âœ… Built $output"
          done

      - name: Commit & push built configs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add example/*.toml
          git commit -m "Auto-build configs from modules" || echo "No changes to commit"
          git push
